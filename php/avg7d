#!/usr/bin/env php
<?php

use AlphaRock\Core\Cli\CliParser;
use AlphaRock\Core\Common\Time;
use AlphaRock\Core\Static\MonkeyCluster;
use AlphaRock\Core\Static\Log;
use AlphaRock\Core\Database\Query\SQL;

require_once __DIR__ . "/src/alpha-quicksight.php";

/** @var CliParser $Cli */
$day = $Cli->getOption('day', Time::today());
Time::toDate($day);

$month = Time::generate($day, Time::ISO_MONTH);
$week= Time::generate($day, Time::ISO_WEEK);


$input = <<<SQL
     SELECT '$day'::date as "ref_day",
     '$week' as "ref_week",
     '$month' as "ref_month"
SQL;

Log::debug("Generating 7d avg for reference day $day");;
$result = MonkeyCluster::query(SQL::fromFile(__DIR__ . "/../sql/data/generate_avg7d.sql", ['{script_input}' => $input]));
$rowCount = $result->getRowCount();
Log::debug("Created 7d avg for $day ($rowCount rows)");;

